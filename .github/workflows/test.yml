name: Test & Build

on:
  push:
    branches: [main, copilot/*]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pystray pillow psutil fastmcp uvicorn
    
    - name: Syntax check
      run: |
        python -m py_compile tray_manager.py
        python -m py_compile config.py
        python -m py_compile unified_server.py
        python -m py_compile connectors/filesystem.py
        python -m py_compile connectors/commander.py
        echo "✅ All syntax OK"
    
    - name: Unit test - PCRemoteToggle
      run: |
        python -c "
        from tray_manager import PCRemoteToggle
        
        app = PCRemoteToggle()
        print('✅ PCRemoteToggle 생성 OK')
        
        # 아이콘 생성 테스트
        icon_on = app.create_icon(True)
        icon_off = app.create_icon(False)
        assert icon_on is not None
        assert icon_off is not None
        print('✅ 아이콘 생성 OK')
        
        # 메뉴 텍스트 테스트
        app.is_running = False
        assert 'OFF' in app.get_menu_text()
        app.is_running = True
        assert 'ON' in app.get_menu_text()
        print('✅ 메뉴 텍스트 OK')
        
        print('✅ 모든 테스트 통과!')
        "

  build:
    needs: test
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pystray pillow psutil fastmcp uvicorn pyinstaller
    
    - name: Build EXE
      run: |
        pyinstaller --onefile --noconsole --name PCRemoteToggle --icon=NONE tray_manager.py
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: PCRemoteToggle-Windows
        path: dist/PCRemoteToggle.exe
